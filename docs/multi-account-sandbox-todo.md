# 多账号沙箱机制改进 TODO

## 🔍 当前架构问题分析

### ✅ 现有问题（已解决核心部分）

#### 1. 数据隔离不足
- **问题**: 所有用户数据存储在同一个 `electron-store` 文件中
- **风险**: 用户 cookies、token 等敏感数据混合存储，存在数据泄露风险
- **影响**: 无法为不同账号设置独立的数据访问权限

#### 2. 消息处理共享
- **问题**: 全局单例 `msgService` 处理所有账号消息
- **影响**: 
  - 自动回复逻辑对所有账号生效，无法个性化
  - 无法为不同账号设置不同的消息处理策略
  - 一个账号的消息处理错误可能影响其他账号

#### 3. 浏览器会话共享
- **问题**: 所有账号登录时共享同一个浏览器实例
- **风险**: 
  - 可能存在 Cookie 污染和会话冲突
  - 账号间的登录状态可能相互干扰
  - 无法为不同账号配置不同的浏览器设置

#### 4. 通知系统混乱
- **问题**: 所有账号的通知使用相同的展示方式
- **影响**: 
  - 无法清晰区分不同账号的消息来源
  - 无法为不同账号设置个性化通知偏好
  - 通知管理混乱，用户体验差

#### 5. 资源隔离缺失
- **问题**: 内存、网络连接等资源没有按账号隔离
- **风险**: 
  - 一个账号的资源占用过多可能影响其他账号
  - 无法监控单个账号的资源使用情况
  - 性能问题难以定位到具体账号

---

## 🏗️ 沙箱机制设计方案

### 1. 数据存储沙箱化 🗄️

#### 目标
- 每个账号使用独立的数据存储空间
- 敏感数据加密存储
- 支持数据迁移和备份

#### 任务列表
- [x] 创建 `AccountStore` 类，管理账号级数据存储
- [x] 实现 `EncryptionService`，加密敏感数据
- [x] 重构现有的 `store.service.ts`，支持多存储实例

### 2. 消息处理隔离 💬

#### 目标
- 每个账号拥有独立的消息处理服务
- 支持个性化消息处理策略
- 账号间错误隔离

#### 任务列表
- [x] 创建 `SandboxedMsgService` 管理账号级消息服务
- [x] 重构 `MsgService` 支持实例化

### 3. 浏览器会话隔离 🌐

#### 目标
- 每个账号使用独立的浏览器上下文
- Cookie 和会话完全隔离
- 支持账号级网络代理配置

#### 任务列表
- [x] 创建 `SandboxedBrowserService`
- [x] 重构登录流程，使用独立浏览器上下文
- [x] 实现 Cookie 完全隔离
- [ ] 添加账号级代理配置支持
- [ ] 优化内存管理，及时释放不用的上下文

### 4. 通知系统优化 🔔

#### 目标
- 通知中清晰显示账号信息
- 支持账号级通知偏好设置
- 优化通知展示和管理

#### 任务列表
- [x] 重构通知系统，添加账号标识
- [ ] 优化通知UI，提升用户体验

### 5. 资源管理改进 📊

#### 目标
- 监控每个账号的资源使用
- 实现资源限制和保护
- 提供性能分析工具

#### 任务列表
- [x] 创建 `ResourceMonitor` 类
- [x] 实现内存、CPU、网络使用监控 (已实现基础占位逻辑)

### 6. 配置系统重构 ⚙️

#### 目标
- 支持全局配置和账号级配置
- 配置继承和覆盖机制
- 运行时配置热更新

#### 任务列表
- [x] 设计配置系统架构
- [x] 实现配置继承和覆盖逻辑
- [ ] 创建配置管理界面
- [ ] 添加配置验证和错误处理
- [ ] 实现配置热更新功能

### 7. 安全增强 🛡️

#### 目标
- 实现账号级权限控制
- 独立的操作日志和审计
- 数据安全和隐私保护

#### 任务列表
- [x] 设计权限控制系统
- [x] 实现账号级操作日志
- [x] 添加数据加密和解密服务

---

## 🎯 实施优先级

### 🔴 高优先级（安全相关）
1. **数据存储沙箱化** - 防止数据泄露和冲突
2. **浏览器会话隔离** - 防止账号间相互干扰
3. **安全增强** - 保护用户隐私和数据安全

### 🟡 中优先级（体验相关）
1. **消息处理隔离** - 提升个性化体验
2. **通知系统优化** - 改善用户交互体验
3. **配置系统重构** - 提供更灵活的配置选项

### 🟢 低优先级（性能相关）
1. **资源管理改进** - 优化性能和稳定性

---

## 📁 新增文件结构

```
src/main/
├── sandbox/
│   ├── AccountSandbox.ts           # 账号沙箱管理器
│   ├── SandboxedMsgService.ts      # 沙箱化消息服务
│   ├── SandboxedBrowserService.ts  # 沙箱化浏览器服务
│   └── SandboxConfig.ts            # 沙箱配置管理
├── storage/
│   ├── AccountStore.ts             # 账号级数据存储
│   └── EncryptionService.ts        # 数据加密服务
├── monitoring/
│   └── ResourceMonitor.ts          # 资源监控服务
├── security/
│   ├── SecurityManager.ts          # 安全管理器
│   └── AuditLogger.ts             # 审计日志
└── types/
    └── sandbox.types.ts           # 沙箱相关类型定义
```

---

## ⚠️ 实施注意事项

### 兼容性考虑
- 需要实现数据迁移功能，确保现有用户平滑升级
- 保持API兼容性，避免破坏性变更
- 提供回退机制，出现问题时可以快速恢复

### 性能影响
- 多个沙箱实例会增加内存占用，需要合理管理
- 监控和限制单个账号的资源使用
- 实现懒加载和资源回收机制

### 开发复杂度
- 沙箱机制会增加系统复杂度，需要充分测试
- 需要完善的错误处理和日志记录
- 考虑多账号并发场景的各种边界情况

### 用户体验
- 确保沙箱机制对用户透明，不影响正常使用
- 提供清晰的账号管理界面
- 优化切换账号的响应速度

---

## 🔄 实施时间线

### 第一阶段（1-2周）
- [x] 完成核心架构设计
- [x] 实现数据存储沙箱化
- [x] 创建基础的账号管理功能

### 第二阶段（2-3周）
- [x] 实现浏览器会话隔离
- [x] 重构消息处理系统
- [x] 添加基础的资源监控

### 第三阶段（1-2周）
- [x] 优化通知系统
- [x] 完善配置管理
- [x] 添加安全增强功能

### 第四阶段（1周）
- [ ] 全面测试和优化
- [ ] 完善文档和用户指南
- [ ] 发布和用户反馈收集

---

## 📋 测试计划

### 功能测试
- [ ] 多账号并发登录测试
- [ ] 数据隔离和安全测试
- [ ] 消息处理和通知测试
- [ ] 配置管理测试

### 性能测试
- [ ] 内存使用和泄漏测试
- [ ] 资源占用监控测试
- [ ] 并发性能测试

### 兼容性测试
- [ ] 数据迁移测试
- [ ] 版本升级测试
- [ ] 不同操作系统测试

---

**📅 创建时间**: 2025-01-06
**👤 负责人**: 开发团队
**📝 状态**: 核心功能开发完成
**🔄 最后更新**: 2025-08-06